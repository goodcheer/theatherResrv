<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .seat {
            width: 15px;
            height: 15px;
            background: yellow;
        }

        .reserved {
            background: red;

        }

        .my-reserve {
            background: blue;
        }
    </style>
    <script src="utils/localStorageHelper.js"></script>

</head>
<body>
<div id = "movieTitle">
</div>
<table id="thread-table">
    <thead>
    <tr>
        <th id="screen">screen</th>
    </tr>
    </thead>
    <tbody id="thread-seat" data-row="" data-column="">

    </tbody>
</table>
    <div >
      <h5>선택 좌석 정보: </h5>
      <h5 id = "trySeat"></h5>
    </div>
    <button onclick = "myReserve()"> 예약하기</button>
</body>

<script>
//예약하기 버튼 누를 때 수행
function myReserve(){
  var resv_info = localStorage.getItem("resv_info");
	resv_info = JSON.parse(resv_info);
  for (var i = 0; i< resvSeat.length;  i++){
    var newResv = {"id":myid, "name":userName, "seat":resvSeat[i], "movie":movieTitle};
    }

  localStorage.setItem ("resv_info",JSON.stringify(resv_info));
//예약횟수 증가
  var id = sessionStorage.getItem("id");
  console.log(id);
  var user_info = localStorage.getItem("user_info");
  user_info = JSON.parse(user_info);
  console.log(user_info);
  for (var i = 0; i < user_info.length; i++){
    if (user_info[i].id == id){
          user_info[i].resvNum = parseInt(user_info[i].resvNum)+resvSeat.length;
          console.log(user_info[i].resvNum);
    }
  }
  console.log(user_info);
  localStorage.setItem ("user_info",JSON.stringify(user_info));


}



//테이블 정보
    var threadInfo = {
        threadName : '좌석',
        row: 13,
        column: 12,
        reserveList: [{
            user : 'user2',
            seatId : 'A2'
        }]
    };

    //현재 영화에 대한 정보와 회원정보를 출력
    var movieTitle = sessionStorage.getItem("movieTitle");
    mvt = document.createElement('h3');
    mvt.innerHTML= movieTitle;

    var userName = sessionStorage.getItem("userName");
    usn = document.createElement('h5');
    usn.innerHTML = userName+'님의 예약진행';

    var myid = sessionStorage.getItem("id");

    document.querySelector('#movieTitle').appendChild(mvt);
    document.querySelector('#movieTitle').appendChild(usn);

    var resvSeat = [];

// 좌석 생성
    for (let i = 0; i < threadInfo.row; i++) {
        let threadRow = document.createElement('tr');
        for (let j = 0; j < threadInfo.column; j++) {
            let seat = document.createElement('td');
            seat.className = 'seat';
            const row = String.fromCharCode(65 + i);
            if (j==0) {
              seat.dataset.row = row;
              seat.dataset.column = j;
              seat.innerHTML = row;
            }
            else{
              seat.dataset.row = row;
              seat.dataset.column = j;
              seat.innerHTML = row + j;
              const isReserved = threadInfo.reserveList.every(function (reserveData) {
                  return reserveData.seatId === row + j;
              });
              if(isReserved) seat.classList.add('reserved');
            }
            threadRow.appendChild(seat);
        }
        document.querySelector('#thread-seat').appendChild(threadRow);
    }

    //예매 시도 관리
    var threadSeat = document.querySelector('#thread-seat');
    threadSeat.addEventListener('click', function (e) {
        if(e.target.classList.contains('reserved')){
            alert('이미 예약된 좌석입니다.');
            return;
        }
        if (e.target.classList.contains('my-reserve')) {
            e.target.classList.remove('my-reserve' );
            for (var i = 0; i<resvSeat.length; i++){
              if (resvSeat[i]==e.target.dataset.row+e.target.dataset.column){
                resvSeat.splice(i,1);
              }
            }
              console.log(resvSeat);

        } else {
            e.target.classList.add('my-reserve');
            resvSeat.push(e.target.dataset.row+e.target.dataset.column);
            console.log(resvSeat[0]);
        }
    var trySeat = document.querySelector('#trySeat');
    trySeat.innerHTML = " ";
      for (var i = 0; i<resvSeat.length; i++){
        if (i==0){
          console.log(resvSeat[i])
          trySeat.innerHTML += String (resvSeat[i]);
        }
        else{
          console.log(resvSeat[i])
          trySeat.innerHTML += String (", "+resvSeat[i]);
        }

      }


    });

    var submit = document.querySelector('#summit');




</script>
</html>
